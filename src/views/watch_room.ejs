<%- include('common/header', { user: typeof user !== 'undefined' ? user : null, title: '영상 함께보기' }) %>
<link href="https://vjs.zencdn.net/7.17.0/video-js.css" rel="stylesheet" />
<style>
    .chat-message-item {
        position: relative;
        padding-right: 55px; /* 공간 확보 */
    }
    .chat-message-item .report-btn {
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        padding: .1rem .3rem; /* 버튼 크기 축소 */
        font-size: .75rem;   /* 폰트 크기 축소 */
    }
    .chat-message-item:hover .report-btn {
        opacity: 1;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-body">
                    <h1 class="mb-4"><%= post.title %></h1>
                    <% if (post.video) { %>
                        <video id="shared-video" class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" preload="auto" data-setup='{"fluid": true}'>
                            <source src="/<%= post.video.file_path.replace(/\\/g, '/') %>" type="<%= post.video.mimetype %>">
                            브라우저가 비디오 태그를 지원하지 않습니다.
                        </video>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button id="create-clip-btn" class="btn btn-info">클립 만들기</button>
                            <span id="video-timer" class="badge bg-secondary">00:00 / 00:00</span>
                        </div>
                    <% } else { %>
                        <p class="text-center">재생할 영상이 없습니다.</p>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <% if (isHost) { %>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>리모컨</h5>
                </div>
                <div class="card-body text-center">
                    <button id="remote-play" class="btn btn-primary me-2">재생</button>
                    <button id="remote-pause" class="btn btn-secondary">일시정지</button>
                </div>
            </div>
            <% } %>
            <div class="card">
                <div class="card-header">
                    <h5>참가자 목록</h5>
                </div>
                <ul id="user-list" class="list-group list-group-flush">
                    <!-- User list will be populated here -->
                </ul>
            </div>
            <div class="mt-3">
                 <p>이 링크를 친구에게 공유하여 함께보세요: <a href="<%= watchUrl %>"><%= watchUrl %></a></p>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>채팅</h5>
                </div>
                <div class="card-body chat-box" style="height: 250px; overflow-y: auto;">
                    <ul id="chat-messages" class="list-unstyled mb-0">
                    </ul>
                </div>
                <div class="card-footer">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="메시지 입력..." autocomplete="off" required>
                            <button class="btn btn-primary" type="submit">전송</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clip Creation Modal -->
<div class="modal fade" id="clipModal" tabindex="-1" aria-labelledby="clipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clipModalLabel">클립 만들기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="clip-form">
                    <div class="mb-3">
                        <label for="clip-title" class="form-label">클립 제목</label>
                        <input type="text" class="form-control" id="clip-title" required>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="start-time" class="form-label">시작 시간</label>
                            <input type="text" class="form-control" id="start-time" placeholder="00:00" required>
                        </div>
                        <div class="col">
                            <label for="end-time" class="form-label">종료 시간</label>
                            <input type="text" class="form-control" id="end-time" placeholder="00:00" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="submit" form="clip-form" class="btn btn-primary">생성하기</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="report-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">사용자 신고하기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>신고 대상:</strong> <span id="reported-username"></span></p>
                    <div class="mb-3">
                        <label class="form-label">신고 대상 채팅:</label>
                        <p class="form-control-plaintext bg-light p-2 rounded" id="reported-chat-message"></p>
                    </div>
                    <div class="mb-3">
                        <label for="report-reason" class="form-label">상세 신고 사유:</label>
                        <textarea class="form-control" id="report-reason" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="reported-userid" name="reported_user_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-danger">신고하기</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script id="user-data" type="application/json"><%- JSON.stringify(user || null) %></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://vjs.zencdn.net/7.17.0/video.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const isHost = <%- JSON.stringify(isHost) %>;
        const roomId = '<%= post.id %>';
        const player = videojs('shared-video');
        const currentUser = JSON.parse(document.getElementById('user-data').textContent || 'null');
        
        let isReceivingSync = false;

        // Timer elements
        const timerDisplay = document.getElementById('video-timer');

        // Clip elements
        const createClipBtn = document.getElementById('create-clip-btn');
        const clipModal = new bootstrap.Modal(document.getElementById('clipModal'));
        const clipForm = document.getElementById('clip-form');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const clipTitleInput = document.getElementById('clip-title');

        // Chat elements
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatBox = document.querySelector('.chat-box');
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const reportForm = document.getElementById('report-form');

        // Disable controls for ALL users. Host will use the remote.
        player.controls(false);

        const formatTime = (seconds) => {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        const parseTime = (timeString) => {
            const parts = timeString.split(':').map(Number);
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                return parts[0] * 60 + parts[1];
            }
            return null;
        }

        player.on('loadedmetadata', () => {
            if (timerDisplay) {
                timerDisplay.textContent = `00:00 / ${formatTime(player.duration())}`;
            }
        });

        player.on('timeupdate', () => {
            if (timerDisplay) {
                timerDisplay.textContent = `${formatTime(player.currentTime())} / ${formatTime(player.duration())}`;
            }
        });

        const socket = io();
        socket.emit('join_room', { roomId, user: currentUser ? { id: currentUser.id, name: currentUser.name } : { name: 'Guest' } });

        if (isHost) {
            const playBtn = document.getElementById('remote-play');
            const pauseBtn = document.getElementById('remote-pause');

            const sendControl = (type, currentTime) => {
                socket.emit('host_control', {
                    roomId: roomId,
                    type: type,
                    currentTime: currentTime
                });
            };

            // Remote listeners control the LOCAL player directly.
            // The player's event listeners below will then sync the action to others.
            playBtn.addEventListener('click', () => player.play());
            pauseBtn.addEventListener('click', () => player.pause());

            // Player listeners
            player.on('play', () => {
                if (isReceivingSync) return;
                sendControl('play', player.currentTime());
            });
            player.on('pause', () => {
                if (isReceivingSync) return;
                sendControl('pause', player.currentTime());
            });
            player.on('seeked', () => {
                if (isReceivingSync) return;
                sendControl('seek', player.currentTime());
            });
        }

        socket.on('update_user_list', (users) => {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = user.name + (user.id === socket.id ? ' (나)' : '');
                userList.appendChild(li);
            });
        });

        socket.on('sync_control', (data) => {
            const { type, currentTime } = data;
            isReceivingSync = true;

            const smallTimeDiff = Math.abs(player.currentTime() - currentTime);
            if (smallTimeDiff > 1.5) { // Sync time if it's off by more than 1.5s
                player.currentTime(currentTime);
            }

            switch (type) {
                case 'play':
                    player.play();
                    break;
                case 'pause':
                    player.pause();
                    break;
            }
            
            // Allow player events to be captured again after a short delay
            setTimeout(() => {
                isReceivingSync = false;
            }, 100);
        });

        // Chat Logic
        if (chatForm) {
            chatForm.addEventListener('submit', e => {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    socket.emit('send_message', { message });
                    chatInput.value = '';
                }
            });
        }

        socket.on('new_message', ({ userId, userName, message }) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start chat-message-item';
            
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            let messageHTML = `<div><strong>${userName}:</strong> ${sanitizedMessage}</div>`;

            // Add report button if the message is not from the current user and the sender is not a guest
            if (currentUser && userId && currentUser.id !== userId) {
                messageHTML += `<button class="btn btn-sm btn-outline-danger report-btn" 
                                    data-userid="${userId}" 
                                    data-username="${userName}" 
                                    data-message="${message}">신고</button>`;
            }

            li.innerHTML = messageHTML;
            chatMessages.appendChild(li);
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });

        // Report Logic
        chatMessages.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('report-btn')) {
                const button = e.target;
                const userId = button.dataset.userid;
                const username = button.dataset.username;
                const message = button.dataset.message;
                
                // Populate modal
                document.getElementById('reported-username').textContent = username;
                document.getElementById('reported-chat-message').innerHTML = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                document.getElementById('reported-userid').value = userId;
                
                reportModal.show();
            }
        });

        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reportedUserId = document.getElementById('reported-userid').value;
            const reportedMessage = document.getElementById('reported-chat-message').textContent;
            const reason = document.getElementById('report-reason').value;

            const fullReason = `신고된 채팅: "${reportedMessage}"\n\n신고 사유: ${reason}`;

            try {
                const response = await fetch(`/users/report/user-chat/${reportedUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_text: fullReason }),
                });

                if (response.ok) {
                    alert('신고가 성공적으로 접수되었습니다.');
                    reportModal.hide();
                    reportForm.reset();
                } else {
                    const errorText = await response.text();
                    alert(`신고 실패: ${errorText}`);
                }
            } catch (error) {
                console.error('Error reporting user:', error);
                alert('신고 처리 중 오류가 발생했습니다.');
            }
        });

        // Clip Logic
        if (createClipBtn) {
            createClipBtn.addEventListener('click', () => {
                if (!currentUser) {
                    alert('클립을 만들려면 로그인이 필요합니다.');
                    window.location.href = '/users/login';
                    return;
                }
                startTimeInput.value = formatTime(player.currentTime());
                endTimeInput.value = formatTime(player.currentTime() + 15 > player.duration() ? player.duration() : player.currentTime() + 15);
                clipModal.show();
            });
        }

        if (clipForm) {
            clipForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = clipTitleInput.value;
                const startTime = parseTime(startTimeInput.value);
                const endTime = parseTime(endTimeInput.value);

                if (title && startTime !== null && endTime !== null) {
                    if (startTime >= endTime) {
                        alert('시작 시간은 종료 시간보다 빨라야 합니다.');
                        return;
                    }

                    try {
                        const response = await fetch(`/post/api/posts/${roomId}/clips`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, startTime, endTime }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(`클립이 성공적으로 생성되었습니다!`);
                            
                            // Create a link to the new post
                            const postLink = document.createElement('a');
                            postLink.href = `/post/posts/${result.newPost.id}`;
                            postLink.textContent = `"${result.newPost.title}" 게시글 바로가기`;
                            postLink.classList.add('btn', 'btn-success', 'mt-2');

                            // Show the link in the modal footer or somewhere visible
                            const modalFooter = document.querySelector('#clipModal .modal-footer');
                            
                            // Clear previous links if any
                            const existingLink = modalFooter.querySelector('a');
                            if (existingLink) {
                                existingLink.remove();
                            }
                            
                            modalFooter.appendChild(postLink);
                            
                            // Optionally, hide the modal after a delay or keep it open for the user to click the link
                            // clipModal.hide(); 
                            // clipForm.reset();
                        } else {
                            const errorText = await response.text();
                            alert(`클립 생성 실패: ${errorText}`);
                        }
                    } catch (error) {
                        console.error('Error creating clip:', error);
                        alert('클립 생성 중 오류가 발생했습니다.');
                    }
                } else {
                    alert('유효한 제목과 시간 형식을(MM:SS) 입력해주세요.');
                }
            });
        }
    });
</script>

<%- include('common/footer') %>
