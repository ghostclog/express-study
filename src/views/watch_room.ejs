<%- include('common/header', { user: typeof user !== 'undefined' ? user : null, title: 'ì˜ìƒ í•¨ê»˜ë³´ê¸°' }) %>
<link href="https://vjs.zencdn.net/7.17.0/video-js.css" rel="stylesheet" />
<style>
    .chat-message-item {
        position: relative;
        padding-right: 55px; /* ê³µê°„ í™•ë³´ */
    }
    .chat-message-item .report-btn {
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        padding: .1rem .3rem; /* ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
        font-size: .75rem;   /* í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
    }
    .chat-message-item:hover .report-btn {
        opacity: 1;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-body">
                    <h1 class="mb-4"><%= post.title %></h1>
                    <% if (post.video) { %>
                        <video id="shared-video" class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" preload="auto" data-setup='{"fluid": true}'>
                            <source src="/<%= post.video.file_path.replace(/\\/g, '/') %>" type="<%= post.video.mimetype %>">
                            ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </video>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button id="create-clip-btn" class="btn btn-info">í´ë¦½ ë§Œë“¤ê¸°</button>
                            <span id="video-timer" class="badge bg-secondary">00:00 / 00:00</span>
                        </div>
                    <% } else { %>
                        <p class="text-center">ì¬ìƒí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <% if (isHost) { %>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>ë¦¬ëª¨ì»¨</h5>
                </div>
                <div class="card-body text-center">
                    <button id="remote-play" class="btn btn-primary me-2">ì¬ìƒ</button>
                    <button id="remote-pause" class="btn btn-secondary">ì¼ì‹œì •ì§€</button>
                </div>
            </div>
            <% } %>
            <div class="card">
                <div class="card-header">
                    <h5>ì°¸ê°€ì ëª©ë¡</h5>
                </div>
                <ul id="user-list" class="list-group list-group-flush">
                    <!-- User list will be populated here -->
                </ul>
            </div>
            <div class="mt-3">
                 <p>ì´ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì—¬ í•¨ê»˜ë³´ì„¸ìš”: <a href="<%= watchUrl %>"><%= watchUrl %></a></p>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>ì±„íŒ…</h5>
                </div>
                <div class="card-body chat-box" style="height: 250px; overflow-y: auto;">
                    <ul id="chat-messages" class="list-unstyled mb-0">
                    </ul>
                </div>
                <div class="card-footer">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" required>
                            <button id="emoji-btn" class="btn btn-outline-secondary" type="button">ğŸ˜Š</button>
                            <button class="btn btn-primary" type="submit">ì „ì†¡</button>
                        </div>
                    </form>
                    <emoji-picker class="light" style="position: absolute; bottom: 65px; right: 20px; z-index: 1000; display: none;"></emoji-picker>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clip Creation Modal -->
<div class="modal fade" id="clipModal" tabindex="-1" aria-labelledby="clipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clipModalLabel">í´ë¦½ ë§Œë“¤ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="clip-form">
                    <div class="mb-3">
                        <label for="clip-title" class="form-label">í´ë¦½ ì œëª©</label>
                        <input type="text" class="form-control" id="clip-title" required>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="start-time" class="form-label">ì‹œì‘ ì‹œê°„</label>
                            <input type="text" class="form-control" id="start-time" placeholder="00:00" required>
                        </div>
                        <div class="col">
                            <label for="end-time" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                            <input type="text" class="form-control" id="end-time" placeholder="00:00" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="submit" form="clip-form" class="btn btn-primary">ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="report-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">ì‚¬ìš©ì ì‹ ê³ í•˜ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì‹ ê³  ëŒ€ìƒ:</strong> <span id="reported-username"></span></p>
                    <div class="mb-3">
                        <label class="form-label">ì‹ ê³  ëŒ€ìƒ ì±„íŒ…:</label>
                        <p class="form-control-plaintext bg-light p-2 rounded" id="reported-chat-message"></p>
                    </div>
                    <div class="mb-3">
                        <label for="report-reason" class="form-label">ìƒì„¸ ì‹ ê³  ì‚¬ìœ :</label>
                        <textarea class="form-control" id="report-reason" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="reported-userid" name="reported_user_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-danger">ì‹ ê³ í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script id="user-data" type="application/json"><%- JSON.stringify(user || null) %></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://vjs.zencdn.net/7.17.0/video.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const isHost = <%- JSON.stringify(isHost) %>;
        const roomId = '<%= post.id %>';
        const player = videojs('shared-video');
        const currentUser = JSON.parse(document.getElementById('user-data').textContent || 'null');
        
        let isReceivingSync = false;

        // Timer elements
        const timerDisplay = document.getElementById('video-timer');

        // Clip elements
        const createClipBtn = document.getElementById('create-clip-btn');
        const clipModal = new bootstrap.Modal(document.getElementById('clipModal'));
        const clipForm = document.getElementById('clip-form');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const clipTitleInput = document.getElementById('clip-title');

        // Chat elements
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatBox = document.querySelector('.chat-box');
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const reportForm = document.getElementById('report-form');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.querySelector('emoji-picker');

        // Disable controls for ALL users. Host will use the remote.
        player.controls(false);

        const formatTime = (seconds) => {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        const parseTime = (timeString) => {
            const parts = timeString.split(':').map(Number);
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                return parts[0] * 60 + parts[1];
            }
            return null;
        }

        player.on('loadedmetadata', () => {
            if (timerDisplay) {
                timerDisplay.textContent = `00:00 / ${formatTime(player.duration())}`;
            }
        });

        player.on('timeupdate', () => {
            if (timerDisplay) {
                timerDisplay.textContent = `${formatTime(player.currentTime())} / ${formatTime(player.duration())}`;
            }
        });

        const socket = io();
        socket.emit('join_room', { roomId, user: currentUser ? { id: currentUser.id, name: currentUser.name } : { name: 'Guest' } });

        if (isHost) {
            const playBtn = document.getElementById('remote-play');
            const pauseBtn = document.getElementById('remote-pause');

            const sendControl = (type, currentTime) => {
                socket.emit('host_control', {
                    roomId: roomId,
                    type: type,
                    currentTime: currentTime
                });
            };

            // Remote listeners control the LOCAL player directly.
            // The player's event listeners below will then sync the action to others.
            playBtn.addEventListener('click', () => player.play());
            pauseBtn.addEventListener('click', () => player.pause());

            // Player listeners
            player.on('play', () => {
                if (isReceivingSync) return;
                sendControl('play', player.currentTime());
            });
            player.on('pause', () => {
                if (isReceivingSync) return;
                sendControl('pause', player.currentTime());
            });
            player.on('seeked', () => {
                if (isReceivingSync) return;
                sendControl('seek', player.currentTime());
            });
        }

        socket.on('update_user_list', (users) => {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = user.name + (user.id === socket.id ? ' (ë‚˜)' : '');
                userList.appendChild(li);
            });
        });

        socket.on('sync_control', (data) => {
            const { type, currentTime } = data;
            isReceivingSync = true;

            const smallTimeDiff = Math.abs(player.currentTime() - currentTime);
            if (smallTimeDiff > 1.5) { // Sync time if it's off by more than 1.5s
                player.currentTime(currentTime);
            }

            switch (type) {
                case 'play':
                    player.play();
                    break;
                case 'pause':
                    player.pause();
                    break;
            }
            
            // Allow player events to be captured again after a short delay
            setTimeout(() => {
                isReceivingSync = false;
            }, 100);
        });

        // Emoji Picker Logic
        emojiBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        });

        emojiPicker.addEventListener('emoji-click', event => {
            chatInput.value += event.detail.emoji.unicode;
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (event) => {
            if (!emojiPicker.contains(event.target) && event.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });

        // Chat Logic
        if (chatForm) {
            chatForm.addEventListener('submit', e => {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    socket.emit('send_message', { message });
                    chatInput.value = '';
                }
            });
        }

        socket.on('new_message', ({ userId, userName, message }) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start chat-message-item';
            
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            let messageHTML = `<div><strong>${userName}:</strong> ${sanitizedMessage}</div>`;

            // Add report button if the message is not from the current user and the sender is not a guest
            if (currentUser && userId && currentUser.id !== userId) {
                messageHTML += `<button class="btn btn-sm btn-outline-danger report-btn" 
                                    data-userid="${userId}" 
                                    data-username="${userName}" 
                                    data-message="${message}">ì‹ ê³ </button>`;
            }

            li.innerHTML = messageHTML;
            chatMessages.appendChild(li);
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });

        // Report Logic
        chatMessages.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('report-btn')) {
                const button = e.target;
                const userId = button.dataset.userid;
                const username = button.dataset.username;
                const message = button.dataset.message;
                
                // Populate modal
                document.getElementById('reported-username').textContent = username;
                document.getElementById('reported-chat-message').innerHTML = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                document.getElementById('reported-userid').value = userId;
                
                reportModal.show();
            }
        });

        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reportedUserId = document.getElementById('reported-userid').value;
            const reportedMessage = document.getElementById('reported-chat-message').textContent;
            const reason = document.getElementById('report-reason').value;

            try {
                const response = await fetch(`/users/report/user-chat/${reportedUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason, roomId: roomId }),
                });

                if (response.ok) {
                    alert('ì‹ ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    reportModal.hide();
                    reportForm.reset();
                } else {
                    const errorText = await response.text();
                    alert(`ì‹ ê³  ì‹¤íŒ¨: ${errorText}`);
                }
            } catch (error) {
                console.error('Error reporting user:', error);
                alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Clip Logic
        if (createClipBtn) {
            createClipBtn.addEventListener('click', () => {
                if (!currentUser) {
                    alert('í´ë¦½ì„ ë§Œë“¤ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/users/login';
                    return;
                }
                startTimeInput.value = formatTime(player.currentTime());
                endTimeInput.value = formatTime(player.currentTime() + 15 > player.duration() ? player.duration() : player.currentTime() + 15);
                clipModal.show();
            });
        }

        if (clipForm) {
            clipForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = clipTitleInput.value;
                const startTime = parseTime(startTimeInput.value);
                const endTime = parseTime(endTimeInput.value);

                if (title && startTime !== null && endTime !== null) {
                    if (startTime >= endTime) {
                        alert('ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ë¹¨ë¼ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    try {
                        const response = await fetch(`/post/api/posts/${roomId}/clips`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, startTime, endTime }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(`í´ë¦½ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                            
                            // Create a link to the new post
                            const postLink = document.createElement('a');
                            postLink.href = `/post/posts/${result.newPost.id}`;
                            postLink.textContent = `"${result.newPost.title}" ê²Œì‹œê¸€ ë°”ë¡œê°€ê¸°`;
                            postLink.classList.add('btn', 'btn-success', 'mt-2');

                            // Show the link in the modal footer or somewhere visible
                            const modalFooter = document.querySelector('#clipModal .modal-footer');
                            
                            // Clear previous links if any
                            const existingLink = modalFooter.querySelector('a');
                            if (existingLink) {
                                existingLink.remove();
                            }
                            
                            modalFooter.appendChild(postLink);
                            
                            // Optionally, hide the modal after a delay or keep it open for the user to click the link
                            // clipModal.hide(); 
                            // clipForm.reset();
                        } else {
                            const errorText = await response.text();
                            alert(`í´ë¦½ ìƒì„± ì‹¤íŒ¨: ${errorText}`);
                        }
                    } catch (error) {
                        console.error('Error creating clip:', error);
                        alert('í´ë¦½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    alert('ìœ íš¨í•œ ì œëª©ê³¼ ì‹œê°„ í˜•ì‹ì„(MM:SS) ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            });
        }
    });
</script>

<%- include('common/footer') %>
