<%- include('common/header', { user: user }) %>

<div class="container mt-5 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">관리자 페이지</h1>
    <span class="text-muted">관리자: <%= user.name %></span>
  </div>

  <!-- Nav pills -->
  <ul class="nav nav-pills mb-3" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="user-reports-tab" data-bs-toggle="tab" data-bs-target="#user-reports" type="button" role="tab" aria-controls="user-reports" aria-selected="true">
        사용자 신고
        <span class="badge rounded-pill bg-danger ms-1"><%= userReports.length %></span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="post-reports-tab" data-bs-toggle="tab" data-bs-target="#post-reports" type="button" role="tab" aria-controls="post-reports" aria-selected="false">
        게시글 신고
        <span class="badge rounded-pill bg-danger ms-1"><%= postReports.length %></span>
      </button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="adminTabContent">
    <!-- 사용자 신고 목록 -->
    <div class="tab-pane fade show active" id="user-reports" role="tabpanel" aria-labelledby="user-reports-tab">
      <div class="card">
        <div class="card-header">
          <h5>사용자 신고 목록</h5>
        </div>
        <div class="card-body">
          <table class="table table-hover table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col" style="width: 5%;">#</th>
                <th scope="col" style="width: 15%;">접수 시간</th>
                <th scope="col" style="width: 15%;">신고자</th>
                <th scope="col" style="width: 15%;">신고된 사용자</th>
                <th scope="col">신고 내용</th>
                <th scope="col" style="width: 10%;" class="text-center">조치</th>
              </tr>
            </thead>
            <tbody>
              <% if(userReports.length === 0) { %>
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">접수된 사용자 신고가 없습니다.</td>
                </tr>
              <% } %>
              <% userReports.forEach(function(report) { %>
                <%
                  const separator = '\\n\\n--- 최근 채팅 내역 ---';
                  const parts = report.report_text.split(new RegExp(separator));
                  const reason = parts[0].replace('신고 사유: ', '');
                  const chatHistory = parts.length > 1 ? parts[1] : null;
                %>
                <tr>
                  <th scope="row"><%= report.id %></th>
                  <td><%= new Date(report.createdAt).toLocaleString('ko-KR') %></td>
                  <td><%= report.reporter ? report.reporter.name : 'N/A' %> (#<%= report.reporter_id %>)</td>
                  <td><%= report.reportedUser ? report.reportedUser.name : 'N/A' %> (#<%= report.reported_user_id %>)</td>
                  <td>
                    <span class="d-inline-block text-truncate" style="max-width: 250px;"><%= reason %></span>
                    <% if (chatHistory) { %>
                      <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#chatHistoryModal" data-chat-history="<%= chatHistory.replace(/"/g, '&quot;') %>">
                        채팅 내역
                      </button>
                    <% } %>
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#banUserModal" data-user-id="<%= report.reported_user_id %>">
                      사용자 제재
                    </button>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 게시글 신고 목록 -->
    <div class="tab-pane fade" id="post-reports" role="tabpanel" aria-labelledby="post-reports-tab">
        <div class="card">
            <div class="card-header">
                <h5>게시글 신고 목록</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 5%;">#</th>
                            <th scope="col" style="width: 15%;">접수 시간</th>
                            <th scope="col" style="width: 15%;">신고자</th>
                            <th scope="col">신고된 게시글</th>
                            <th scope="col">신고 사유</th>
                            <th scope="col" style="width: 10%;" class="text-center">조치</th>
                        </tr>
                    </thead>
                    <tbody>
                      <% if(postReports.length === 0) { %>
                        <tr>
                          <td colspan="6" class="text-center text-muted py-4">접수된 게시글 신고가 없습니다.</td>
                        </tr>
                      <% } %>
                      <% postReports.forEach(function(report) { %>
                          <tr>
                              <th scope="row"><%= report.id %></th>
                              <td><%= new Date(report.createdAt).toLocaleString('ko-KR') %></td>
                              <td><%= report.reporter ? report.reporter.name : 'N/A' %></td>
                              <td>
                                  <a href="/post/posts/<%= report.post.id %>" target="_blank" title="<%= report.post.title %>">
                                    <span class="d-inline-block text-truncate" style="max-width: 200px;"><%= report.post.title %></span>
                                  </a>
                                  <small class="text-muted">(#<%= report.post.id %>)</small>
                              </td>
                              <td><span class="d-inline-block text-truncate" style="max-width: 250px;"><%= report.reason %></span></td>
                              <td class="text-center">
                                  <button type="button" class="btn btn-sm btn-secondary" onclick="deletePost('<%= report.post.id %>')">
                                      게시글 삭제
                                  </button>
                              </td>
                          </tr>
                      <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- 채팅 내역 모달 -->
<div class="modal fade" id="chatHistoryModal" tabindex="-1" aria-labelledby="chatHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chatHistoryModalLabel">채팅 내역</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre><code id="chat-history-content"></code></pre>
      </div>
    </div>
  </div>
</div>

<!-- 제재 모달 -->
<div class="modal fade" id="banUserModal" tabindex="-1" aria-labelledby="banUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="banUserModalLabel">사용자 제재</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="banUserForm">
          <div class="mb-3">
            <label for="ban-duration" class="col-form-label">제재 기간 (일):</label>
            <input type="number" class="form-control" id="ban-duration" name="ban_duration_days" min="1" required>
          </div>
          <input type="hidden" id="user-id-to-ban" name="user_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="submitBan">제재하기</button>
      </div>
    </div>
  </div>
</div>

<hr class="my-5">

<div class="container mt-5">
  <h2>게시글 신고 목록</h2>
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">신고 시간</th>
        <th scope="col">신고자 ID</th>
        <th scope="col">작성자 ID</th>
        <th scope="col">원본 글 ID</th>
        <th scope="col">신고 사유</th>
        <th scope="col">상태</th>
        <th scope="col">조치</th>
      </tr>
    </thead>
    <tbody>
      <% postReports.forEach(function(report) { %>
        <% if (report.status === 'pending') { %>
          <tr>
            <th scope="row"><%= report.id %></th>
            <td><%= new Date(report.createdAt).toLocaleString() %></td>
            <td><%= report.reporter_id %></td>
            <td><%= report.reported_user_id %></td>
            <td><%= report.reported_post_id %></td>
            <td><%= report.reason %></td>
            <td><span class="badge bg-warning text-dark"><%= report.status %></span></td>
            <td>
              <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#postSnapshotModal" data-snapshot='<%- JSON.stringify(JSON.parse(report.archived_post_data)) %>'>
                스냅샷 보기
              </button>
              <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#banUserModal" data-user-id="<%= report.reported_user_id %>">
                작성자 제재
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePost('<%= report.reported_post_id %>', '<%= report.id %>')">
                게시글 삭제
              </button>
            </td>
          </tr>
        <% } %>
      <% }); %>
    </tbody>
  </table>
</div>

<!-- Post Snapshot Modal -->
<div class="modal fade" id="postSnapshotModal" tabindex="-1" aria-labelledby="postSnapshotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="postSnapshotModalLabel">게시글 스냅샷</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="snapshot-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 채팅 내역 모달 관련 로직
  const chatHistoryModal = document.getElementById('chatHistoryModal');
  chatHistoryModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const chatHistory = button.getAttribute('data-chat-history');
    const chatContentElement = chatHistoryModal.querySelector('#chat-history-content');
    
    // Trim leading/trailing whitespace and newlines
    chatContentElement.textContent = chatHistory.trim();
  });

  // 사용자 제재 모달 관련 로직 (기존 코드 생략)
  const banUserModal = document.getElementById('banUserModal');
  banUserModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const userId = button.getAttribute('data-user-id');
    const modalTitle = banUserModal.querySelector('.modal-title');
    const userIdInput = banUserModal.querySelector('#user-id-to-ban');

    modalTitle.textContent = `사용자 (ID: ${userId}) 제재`;
    userIdInput.value = userId;
  });

  const submitBanButton = document.getElementById('submitBan');
  submitBanButton.addEventListener('click', function () {
    const userId = document.getElementById('user-id-to-ban').value;
    const banDuration = document.getElementById('ban-duration').value;

    if (!banDuration || parseInt(banDuration, 10) <= 0) {
      alert('제재 기간을 1일 이상으로 입력해주세요.');
      return;
    }

    fetch(`/users/ban/${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ban_duration_days: banDuration
      })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(data => {
      alert(data.message);
      location.reload();
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('오류가 발생했습니다: ' + error.message);
    });
  });

  // Post Snapshot Modal Logic
  const postSnapshotModal = document.getElementById('postSnapshotModal');
  postSnapshotModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const snapshot = JSON.parse(button.getAttribute('data-snapshot'));
    const contentElement = postSnapshotModal.querySelector('#snapshot-content');

    let videoHTML = snapshot.video ?
        `<p><strong>첨부 영상:</strong> <code>${snapshot.video.file_path}</code></p>
         <video src="/${snapshot.video.file_path.replace(/\\\\/g, '/')}" controls class="img-fluid"></video>` :
        '<p>첨부 영상 없음</p>';

    contentElement.innerHTML = `
      <h3>${snapshot.title}</h3>
      <p><strong>작성자:</strong> ${snapshot.writer.name} (ID: ${snapshot.writer.id})</p>
      <p><strong>작성일:</strong> ${new Date(snapshot.createdAt).toLocaleString()}</p>
      <hr>
      <div>${snapshot.contents}</div>
      <hr>
      ${videoHTML}
    `;
  });

  // Delete Post Function
  window.deletePost = async function(postId, reportId) {
    if (!confirm('정말로 이 게시글을 삭제하고 신고를 처리 완료하시겠습니까?')) return;

    try {
      const response = await fetch(`/post/api/posts/${postId}/delete-by-admin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reportId: reportId })
      });
      const result = await response.json();
      if (response.ok) {
        alert(result.message);
        location.reload();
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      alert('오류 발생: ' + error.message);
    }
  }
});
</script>

<%- include('common/footer') %>
