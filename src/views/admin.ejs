<%- include('common/header', { user: user }) %>

<div class="container mt-5">
  <h1>관리자 페이지</h1>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="user-reports-tab" data-bs-toggle="tab" data-bs-target="#user-reports" type="button" role="tab" aria-controls="user-reports" aria-selected="true">사용자 신고 목록</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="post-reports-tab" data-bs-toggle="tab" data-bs-target="#post-reports" type="button" role="tab" aria-controls="post-reports" aria-selected="false">게시글 신고 목록</button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="adminTabContent">
    <!-- 사용자 신고 목록 -->
    <div class="tab-pane fade show active" id="user-reports" role="tabpanel" aria-labelledby="user-reports-tab">
      <h2 class="mt-4">사용자 신고 목록</h2>
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">신고 접수 시간</th>
            <th scope="col">신고자</th>
            <th scope="col">신고된 사용자</th>
            <th scope="col">신고 내용</th>
            <th scope="col">조치</th>
          </tr>
        </thead>
        <tbody>
          <% userReports.forEach(function(report) { %>
            <%
              const separator = '\\n\\n--- 최근 채팅 내역 ---';
              const parts = report.report_text.split(new RegExp(separator));
              const reason = parts[0].replace('신고 사유: ', '');
              const chatHistory = parts.length > 1 ? parts[1] : null;
            %>
            <tr>
              <th scope="row"><%= report.id %></th>
              <td><%= new Date(report.createdAt).toLocaleString() %></td>
              <td><%= report.reporter ? report.reporter.name : 'N/A' %> (<%= report.reporter_id %>)</td>
              <td><%= report.reportedUser ? report.reportedUser.name : 'N/A' %> (<%= report.reported_user_id %>)</td>
              <td>
                <%= reason %>
                <% if (chatHistory) { %>
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#chatHistoryModal" data-chat-history="<%= chatHistory.replace(/"/g, '&quot;') %>">
                    채팅 내역 보기
                  </button>
                <% } %>
              </td>
              <td>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#banUserModal" data-user-id="<%= report.reported_user_id %>">
                  사용자 제재
                </button>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <!-- 게시글 신고 목록 -->
    <div class="tab-pane fade" id="post-reports" role="tabpanel" aria-labelledby="post-reports-tab">
        <h2 class="mt-4">게시글 신고 목록</h2>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">신고 접수 시간</th>
                    <th scope="col">신고자</th>
                    <th scope="col">신고된 게시글</th>
                    <th scope="col">신고 사유</th>
                    <th scope="col">조치</th>
                </tr>
            </thead>
            <tbody>
                <% postReports.forEach(function(report) { %>
                    <tr>
                        <th scope="row"><%= report.id %></th>
                        <td><%= new Date(report.createdAt).toLocaleString() %></td>
                        <td><%= report.reporter ? report.reporter.name : 'N/A' %></td>
                        <td>
                            <a href="/post/posts/<%= report.post.id %>" target="_blank">
                                <%= report.post.title %> (ID: <%= report.post.id %>)
                            </a>
                        </td>
                        <td><%= report.reason %></td>
                        <td>
                            <button type="button" class="btn btn-secondary" onclick="deletePost('<%= report.post.id %>')">
                                게시글 삭제
                            </button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
  </div>
</div>

<!-- 채팅 내역 모달 -->
<div class="modal fade" id="chatHistoryModal" tabindex="-1" aria-labelledby="chatHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chatHistoryModalLabel">채팅 내역</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre><code id="chat-history-content"></code></pre>
      </div>
    </div>
  </div>
</div>

<!-- 제재 모달 -->
<div class="modal fade" id="banUserModal" tabindex="-1" aria-labelledby="banUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="banUserModalLabel">사용자 제재</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="banUserForm">
          <div class="mb-3">
            <label for="ban-duration" class="col-form-label">제재 기간 (일):</label>
            <input type="number" class="form-control" id="ban-duration" name="ban_duration_days" min="1" required>
          </div>
          <input type="hidden" id="user-id-to-ban" name="user_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="submitBan">제재하기</button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  // 채팅 내역 모달 관련 로직
  const chatHistoryModal = document.getElementById('chatHistoryModal');
  chatHistoryModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const chatHistory = button.getAttribute('data-chat-history');
    const chatContentElement = chatHistoryModal.querySelector('#chat-history-content');
    
    // Trim leading/trailing whitespace and newlines
    chatContentElement.textContent = chatHistory.trim();
  });

  // 사용자 제재 모달 관련 로직 (기존 코드 생략)
  const banUserModal = document.getElementById('banUserModal');
  banUserModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const userId = button.getAttribute('data-user-id');
    const modalTitle = banUserModal.querySelector('.modal-title');
    const userIdInput = banUserModal.querySelector('#user-id-to-ban');

    modalTitle.textContent = `사용자 (ID: ${userId}) 제재`;
    userIdInput.value = userId;
  });

  const submitBanButton = document.getElementById('submitBan');
  submitBanButton.addEventListener('click', function () {
    const userId = document.getElementById('user-id-to-ban').value;
    const banDuration = document.getElementById('ban-duration').value;

    if (!banDuration || parseInt(banDuration, 10) <= 0) {
      alert('제재 기간을 1일 이상으로 입력해주세요.');
      return;
    }

    fetch(`/users/ban/${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ban_duration_days: banDuration
      })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(data => {
      alert(data.message);
      location.reload();
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('오류가 발생했습니다: ' + error.message);
    });
  });
});

async function deletePost(postId) {
    if (!confirm(`정말로 이 게시글(ID: ${postId})을 삭제하시겠습니까?`)) return;
    try {
        const response = await fetch(`/post/api/posts/${postId}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            alert('게시글이 성공적으로 삭제되었습니다.');
            location.reload();
        } else {
            const errorText = await response.text();
            alert(`게시글 삭제에 실패했습니다: ${errorText}`);
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('게시글 삭제 중 오류가 발생했습니다.');
    }
}
</script>

<%- include('common/footer') %>
